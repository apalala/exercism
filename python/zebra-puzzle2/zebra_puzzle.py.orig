import sys

WHO = ('Japanese', 'Spaniard', 'Norweigan', 'Ukranian', 'Englishman')
COLOR = ('blue', 'red', 'ivory', 'yellow', 'green')
OWNS = ('dog', 'fox', 'zebra', 'snails', 'horse')
DRINKS = ('milk', 'tea', 'orange juice', 'coffee', 'water')
SMOKES = ('Chesterfield', 'Old Gold', 'Kool', 'Parliament', 'Lucky Strike')


def new_house(n):
    return dict(
        n={n},
        who=set(WHO),
        color=set(COLOR),
        owns=set(OWNS),
        drinks=set(DRINKS),
        smokes=set(SMOKES),
    )


def defined(house):
    values = [len(v) if isinstance(v, set) else 1 for v in house.values()]
    return min(values ) == 1 and max(values) == 1


def remove(house, **kwargs):
    for k, v in kwargs.items():
        if v in house[k]:
            print('remove', repr(v), 'from', house['n'])
            house[k] -= {v}


def enforce(houses, **kwargs):
    for house in houses:
        for ak, av in kwargs.items():
           for bk, bv in kwargs.items():
               if ak == bk:
                   continue
               if av not in house[ak]:
                   remove(house, **{bk: bv})


def get(houses, nums, key):
    result = set()
    for i in nums:
        if i >= 0 and i < len(houses):
            result |= houses[i][key]
    return result


def solution():
    # 1
    houses = [new_house(n) for n in range(5)]
    count = 0
    while count < 5: # and not all(defined(h) for h in houses):
        count += 1
        print(count)
        for i, h in enumerate(houses):
            print(i, list(h.values()))
        print()
        # 2
        enforce(houses, color='red', who='Englishman')
        # 3
        enforce(houses, owns='dog', who='Spaniard')
        # 4
        enforce(houses, drinks='coffee', color='green')
        # 5
        enforce(houses, drinks='tea', who='Ukranian')
        # 6
        remove(houses[0], color='green')
        for i, house in enumerate(houses[1:-1], 1):
            if 'ivory' not in houses[i - 1]['color']:
                remove(house, color='green')
            if 'green' not in houses[i + 1]['color']:
                remove(house, color='ivory')
        remove(houses[-1], color='ivory')
        # 7
        enforce(houses, owns='snails', smokes='Old Gold')
        # 8
        enforce(houses, smokes='Kool', color='yellow')
        # 9
        enforce(houses, n=2, drinks='milk')
        houses[2]['drinks'] = {'milk'}
        # 10
        enforce(houses, n=0, who='Norweigan')
        houses[0]['who'] = {'Norweigan'}
        # 11
        for i, house in enumerate(houses):
            if 'Chesterfield' not in get(houses, [i - 1, i + 1], 'smokes'):
                remove(house, owns='fox')
            if 'fox' not in get(houses, [i - 1, i + 1], 'owns'):
                remove(house, smokes='Chesterfield')
        # 12
        for i, house in enumerate(houses):
            if 'Kool' not in get(houses, [i - 1, i + 1], 'smokes'):
                remove(house, owns='horse')
            if 'horse' not in get(houses, [i - 1, i + 1], 'owns'):
                remove(house, smokes='Kool')
        # 13
        enforce(houses, drinks='orange juice', smokes='Lucky Strike')
        # 14
        enforce(houses, who='Japanese', smokes='Parliament')
        # 12
        for i, house in enumerate(houses):
            if 'blue' not in get(houses, [i - 1, i + 1], 'color'):
                remove(house, who='Norweigan')
            if 'Norweigan' not in get(houses, [i - 1, i + 1], 'who'):
                remove(house, color='blue')

        for i, house in enumerate(houses):
            for k in house:
                if k == 'n' or len(house[k]) == 1:
                    continue
                for v in list(house[k]):
                    where = {j for j, h in enumerate(houses) if v in h[k]}
                    if where == {i}:
                        print(k, v, 'only in', i)
                        house[k] = {v}
                        break
